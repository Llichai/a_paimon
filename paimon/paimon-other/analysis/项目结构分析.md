# Apache Paimon 项目结构深度分析

## 一、项目概览

**项目名称**: Apache Paimon
**版本**: 1.4-SNAPSHOT
**总Java文件数**: 约 2,698 个
**核心模块**: paimon-api、paimon-common、paimon-core
**构建工具**: Maven
**Java版本**: 1.8 (默认)，支持 Java 11/17

## 二、模块分层架构

### 分层关系
```
第1层（API层）
    ↑ paimon-api (199个Java文件)

第2层（通用层）
    ↑ paimon-common (575个Java文件)

第3层（核心层）
    ↑ paimon-core (767个Java文件)
    ↓ paimon-format (129个Java文件)

第4层（集成层）
    ↑ paimon-flink (688个文件)
    ↑ paimon-spark (94个文件)
    ↑ paimon-hive (63个文件)

第5层（存储层）
    ↑ paimon-filesystems (多个云存储实现)
```

## 三、核心三大模块

### 3.1 paimon-api（轻量级API层）
**职责**: 提供最小依赖的API接口层
**包含内容**:
- 类型系统 (types)
- 表和视图抽象 (table, view)
- Catalog 接口 (catalog)
- 配置选项 (CoreOptions)
- REST API 接口 (rest)
- 文件索引接口 (fileindex)

**特点**: 无Paimon内部依赖，不引入Hadoop等重依赖

### 3.2 paimon-common（通用基础设施层）
**职责**: 提供跨模块的公共功能
**关键子包**:
- data/ - 数据结构和类型处理
- fs/ - 文件系统抽象
- format/ - 数据格式处理
- compression/ - 序列化压缩
- codegen/ - 代码生成
- predicate/ - 谓词和过滤器
- statistics/ - 统计信息
- fileindex/ - 文件索引
- io/ - IO操作
- deletionvectors/ - 删除向量

**代码规模**: 575个Java文件

### 3.3 paimon-core（核心存储引擎）
**职责**: 实现LSM树、表的读写、压缩、快照管理等核心功能
**关键子包**:
- mergetree/ - LSM树实现、压缩策略
- compact/ - 数据压缩引擎
- manifest/ - 元数据管理
- schema/ - Schema演化
- snapshot/ - 快照管理
- bucket/ - 分桶操作
- catalog/ - Catalog实现
- table/ - 表操作
- index/ - 索引功能
- sort/ - 排序功能

**代码规模**: 767个Java文件
**依赖**: paimon-common, paimon-codegen-loader
**特点**: 使用RocksDB作为状态后端

## 四、关键功能领域

### 4.1 存储引擎 (mergetree/)
- UniversalCompaction - LSM压缩策略
- LeveledCompaction - 分层压缩
- LoserTree - 败者树归并
- MergeSorter - 归并排序器
- RecordReader - 记录读取器

### 4.2 数据合并 (compact/)
- DeduplicateMergeFunction - 去重合并
- FirstRowMergeFunction - 首行保留
- PartialUpdateMergeFunction - 部分更新合并
- SequenceFieldMergeFunction - 序列字段合并
- BuiltInMergeFunction - 内置合并函数

### 4.3 索引优化 (sort/, globalindex/)
- ZIndexer - Z-Order多维索引
- HilbertIndexer - Hilbert曲线索引
- BTreeIndexWriter - B-Tree全局索引
- BloomFilter - 布隆过滤器
- FileIndexReader - 文件索引读取

### 4.4 查询优化 (flink/, spark/)
- PredicateConverter - 谓词下推转换
- OrcFilters - ORC格式过滤
- ParquetFilters - Parquet格式过滤
- PartitionPruning - 分区剪枝

### 4.5 元数据管理 (manifest/, snapshot/)
- ManifestFileMerger - Manifest合并
- SnapshotReaderImpl - Snapshot读取
- StatisticsCollector - 统计信息收集
- VersionedFile - 版本文件管理

## 五、数据格式支持

| 格式 | 模块 | 特点 |
|------|------|------|
| ORC | paimon-format | 原生支持，列式压缩 |
| Parquet | paimon-format | 列式存储，压缩高效 |
| Avro | paimon-format | 行式格式 |
| Arrow | paimon-arrow | 内存列式格式 |
| Lance | paimon-lance | 向量化格式 |

## 六、计算引擎集成

### Flink 集成 (paimon-flink/)
- 支持版本: Flink 1.16 - 2.2
- CDC 支持: paimon-flink-cdc
- 流式读写集成

### Spark 集成 (paimon-spark/)
- 支持版本: Spark 3.2 - 4.0
- Scala编写
- DataFrame集成

### Hive 集成 (paimon-hive/)
- Hive 2.1 - 3.1支持
- Catalog实现
- 连接器支持

## 七、云存储支持

- **AWS**: S3 (paimon-s3)
- **阿里云**: OSS (paimon-oss), Jindo (paimon-jindo)
- **腾讯云**: COS (paimon-cosn)
- **Google**: GCS (paimon-gs)
- **Microsoft**: Azure Blob (paimon-azure)
- **华为云**: OBS (paimon-obs)

## 八、特色功能

### 全文搜索
- paimon-lucene: Apache Lucene集成（需要Java 11+）

### 向量索引
- paimon-faiss: Facebook AI Similarity Search
- paimon-lance: 列式向量格式

### 格式兼容
- paimon-iceberg: Iceberg互操作
- paimon-hudi: Hudi互操作

## 九、代码规模统计

| 模块 | 文件数 | 说明 |
|------|--------|------|
| paimon-core | 767 | 核心存储引擎 |
| paimon-flink | 688 | Flink集成 |
| paimon-common | 575 | 通用基础设施 |
| paimon-api | 199 | 轻量级API |
| paimon-format | 129 | 数据格式 |
| paimon-spark | 94 | Spark集成 |
| paimon-hive | 63 | Hive集成 |
| **总计** | **2,698** | 主源代码文件 |

## 十、架构特点

1. **分层清晰**: API → Common → Core → Format → Bundle → Integration
2. **松耦合设计**: 通过接口隔离，降低依赖复杂度
3. **多引擎支持**: Flink、Spark、Hive三大计算框架
4. **多版本兼容**: 各引擎支持多个版本，自动版本选择
5. **云原生**: 支持主流云存储服务
6. **生态丰富**: 格式多样（ORC、Parquet、Avro、Arrow、Lance）
7. **性能优化**: LSM树压缩、索引加速、谓词下推、分区剪枝
8. **AI/ML友好**: 向量存储、全文索引支持

---

*本文档由自动化分析工具生成*
