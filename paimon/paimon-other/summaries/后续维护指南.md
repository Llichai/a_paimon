# Paimon 项目后续维护指南

本指南为 Paimon 项目的长期维护提供规范、工具和最佳实践。

---

## 第一部分：注释维护规范

### 1.1 代码审查中的注释检查

#### ✅ 审查清单

**PR 合并前，必须检查以下项目**：

| 项目 | 检查方式 | 说明 |
|------|---------|------|
| JavaDoc 完整性 | `git diff --check` | 确保公开类/方法都有 JavaDoc |
| 注释准确性 | 代码审查 | 注释与实现是否一致 |
| 注释风格 | 风格检查工具 | 是否遵循统一规范 |
| 中文表达 | 人工审查 | 避免歧义、表达清晰 |
| 示例代码 | 是否可执行 | 代码示例必须能编译运行 |

#### 🔍 检查脚本示例

```bash
#!/bin/bash
# 检查缺少 JavaDoc 的公开方法

git diff --cached HEAD | grep -E "^\+.*public " | while read line; do
    # 检查该方法前是否有 /**
    if ! grep -q "/\*\*" <<< "$line"; then
        echo "⚠️ 检查到可能缺少 JavaDoc 的公开方法"
        echo "$line"
    fi
done
```

#### 💬 审查意见模板

```
审查意见: 注释问题

【问题】
- 类 XXX 的方法 yyy 缺少 JavaDoc
- 算法说明不够详细
- 代码示例中的公式标记不清晰

【建议】
- 按照《注释规范文档.md》添加 JavaDoc
- 参考《算法难点详解.md》补充算法说明
- 使用 <pre> 标签格式化公式

【参考】
- 见 UniversalCompaction.java 的优秀示例
```

---

### 1.2 注释同步更新机制

#### 代码修改时的注释更新

**当修改代码时，必须同时检查注释**：

```
修改前:
/**
 * 方法功能说明
 */
public void oldMethod() {
    // 旧实现
    ...
}

修改后:
/**
 * 方法功能说明（如有变化）
 *
 * <p>修改说明（如需要）:
 * - 原因：XXX
 * - 影响：YYY
 */
public void oldMethod() {
    // 新实现
    ...
    // 新增注释说明
}
```

#### 检查清单

```markdown
[ ] JavaDoc 是否需要更新
[ ] 代码内注释是否与新逻辑一致
[ ] 是否添加了解释变更原因的注释
[ ] 示例代码是否仍然有效
[ ] 是否需要更新参考文档链接
```

#### 常见错误

❌ **错误1: 过时注释**
```java
// 错误：代码改了但注释没改
// 计算字段和值的映射关系
Map<String, Integer> map = computeNewValue();  // 实际上返回的是 UUID 映射
```

✅ **正确方式**:
```java
// 从字段名映射到 UUID
Map<String, String> map = computeNewUuidMapping();
```

---

### 1.3 注释质量监控

#### 定期检查（每月一次）

```bash
#!/bin/bash
# 生成注释覆盖率报告

echo "=== JavaDoc 覆盖率分析 ==="

for module in paimon-api paimon-common paimon-core; do
    echo "检查模块: $module"

    # 统计公开类
    public_classes=$(find $module -name "*.java" | \
        xargs grep -l "public class" | wc -l)

    # 统计有 JavaDoc 的公开类
    documented=$(find $module -name "*.java" | \
        xargs grep -B1 "public class" | grep -c "/\*\*")

    coverage=$((documented * 100 / public_classes))
    echo "  公开类覆盖率: $coverage% ($documented/$public_classes)"
done
```

#### 质量评分标准

| 等级 | 条件 | 行动 |
|------|------|------|
| ⭐⭐⭐⭐⭐ | JavaDoc + 算法说明 + 示例 | 保持 |
| ⭐⭐⭐⭐ | JavaDoc + 主要逻辑注释 | 维护 |
| ⭐⭐⭐ | JavaDoc + 基础注释 | 改进 |
| ⭐⭐ | 仅有 JavaDoc | 补充 |
| ⭐ | 缺少 JavaDoc | 整改 |

---

## 第二部分：文档维护

### 2.1 文档更新计划

#### 更新周期

| 文档 | 更新周期 | 触发条件 |
|------|---------|---------|
| `项目结构分析.md` | 6 个月 | 新增主要模块 |
| `算法难点详解.md` | 3 个月 | 新增核心算法 |
| `注释规范文档.md` | 6 个月 | 规范调整 |
| `源码理解快速指南.md` | 3 个月 | 重大版本发布 |

#### 版本号管理

```
文档版本: v{主版本}.{修订}.{更新}

v1.0.0 - 初始版本（2026年2月）
v1.1.0 - 添加新算法说明（2026年5月）
v1.2.0 - 优化注释规范（2026年8月）
v2.0.0 - 主要改进，不兼容向后参考（2027年）
```

#### 更新流程

```
1. 检查是否有大的变化（新模块、新算法、新特性）
2. 整理需要更新的章节
3. 更新对应的 .md 文件
4. 运行文档检查脚本
5. 提交 PR 并说明变更理由
6. 在项目公告中宣布文档更新
```

---

### 2.2 文档检查工具

#### 链接检查工具

```bash
#!/bin/bash
# 检查文档中的所有链接是否有效

echo "检查文档链接..."

for file in paimon-other/analysis/*.md paimon-other/summaries/*.md; do
    echo "检查: $file"
    grep -o 'https://[^ ]*' "$file" | while read url; do
        # 检查链接是否返回 200
        status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
        if [ "$status" != "200" ]; then
            echo "  ⚠️ 链接失效: $url (HTTP $status)"
        fi
    done
done
```

#### 引用检查工具

```bash
#!/bin/bash
# 检查文档中引用的文件是否存在

echo "检查文件引用..."

grep -r "文件路径\|File:" paimon-other/ | grep -oE "paimon-.*\.java" | while read file; do
    if [ ! -f "$file" ]; then
        echo "⚠️ 文件不存在: $file"
    fi
done
```

---

## 第三部分：性能优化建议

### 3.1 压缩性能优化

#### 参数调优指南

基于表规模和工作负载特征的参数推荐：

| 场景 | maxSizeAmp | sizeRatio | numRunTrigger |
|------|-----------|-----------|---------------|
| 小表 (<10GB) | 200 | 1 | 4 |
| 中表 (10-100GB) | 150 | 2 | 5 |
| 大表 (100GB-1TB) | 100 | 5 | 10 |
| 超大表 (>1TB) | 50 | 10 | 20 |

#### 非峰值压缩启用

```java
// 在创建 Table 时启用非峰值压缩
CoreOptions options = new CoreOptions(props);

// 配置非峰值时段（23:00-07:00）
options.set(
    "compaction.off-peak-hours",
    "23,0,1,2,3,4,5,6,7"
);

// 非峰值时段的激进程度
options.set("compaction.off-peak-ratio", "20");
```

### 3.2 查询性能优化

#### 统计信息收集

```java
// 定期收集统计信息
Table table = catalog.getTable(tableName);
TableStats stats = table.stats();

// 检查统计信息的新鲜度
long lastUpdate = stats.lastUpdateTime();
if (System.currentTimeMillis() - lastUpdate > 7 * 24 * 3600 * 1000) {
    // 7天未更新，建议重新计算
    table.analyzeTable();
}
```

#### 索引创建建议

```java
// 为高频查询的列创建文件索引
Options options = new Options();
options.set("file-index.columns", "user_id,timestamp");
options.set("file-index.type", "bitmap");

// 或使用全局索引（需要额外存储开销）
options.set("globalindex.enabled", "true");
options.set("globalindex.type", "btree");
```

### 3.3 内存使用优化

#### 写缓冲配置

```properties
# 内存中保留的最大记录数
write-buffer-size=256MB

# 内存排序使用的比例
sort-in-memory-ratio=0.8

# 达到阈值后开始溢写磁盘
sort-spill-threshold=100000
```

---

## 第四部分：问题诊断与排查

### 4.1 常见问题排查

#### 问题1: 压缩队列堆积

**症状**：
- `CompactionQueue` 中任务持续增加
- 压缩不及时，读取性能下降

**排查步骤**：

```bash
# 1. 检查日志中的压缩信息
grep "compaction" logs/*.log | tail -100

# 2. 查看当前压缩队列大小
SELECT COUNT(*) FROM manifest_files WHERE status='compacting';

# 3. 检查压缩策略是否频繁触发
grep "Universal compaction due to" logs/*.log | wc -l

# 4. 调整压缩参数以降低频率
# 减少 numRunCompactionTrigger，增加 sizeRatio
```

**解决方案**：
- 增加压缩线程数：`compaction.parallelism`
- 调整参数降低压缩频率
- 扩大机器规格提升 I/O 性能

#### 问题2: OOM（内存溢出）

**症状**：
- `OutOfMemoryError: Java heap space`
- 大批量写入时容易发生

**排查步骤**：

```java
// 1. 检查当前内存使用
Runtime runtime = Runtime.getRuntime();
long usedMemory = runtime.totalMemory() - runtime.freeMemory();
long maxMemory = runtime.maxMemory();
System.out.println("内存使用: " + usedMemory + " / " + maxMemory);

// 2. 检查 WriteBuffer 大小
System.out.println("WriteBuffer: " + writeBuffer.getSize());

// 3. 监控 RocksDB 内存占用
System.out.println("RocksDB 内存: " + rocksdbMemory);
```

**解决方案**：
- 减少 `write-buffer-size` 参数
- 增加 JVM 堆内存（谨慎）
- 降低写入吞吐量，分批处理

#### 问题3: 查询性能下降

**症状**：
- 查询延迟增加 10 倍以上
- 即使数据量未增加

**排查步骤**：

```sql
-- 1. 检查文件数量
SELECT COUNT(*) FROM data_files;  -- 过多则需要压缩

-- 2. 检查分区分布
SELECT partition, COUNT(*) FROM data_files GROUP BY partition;

-- 3. 检查统计信息是否过时
SELECT last_update FROM table_stats;

-- 4. 查看是否有大量删除记录
SELECT COUNT(*) FROM deletion_vectors;
```

**解决方案**：
- 触发全量压缩或重新压缩
- 更新统计信息：`ANALYZE TABLE`
- 清理删除向量
- 检查分区策略是否合理

---

### 4.2 性能诊断工具

#### 构建诊断报告

```bash
#!/bin/bash
# 生成完整的性能诊断报告

cat > diagnostic-report.txt << EOF
=== Paimon 性能诊断报告 ===
生成时间: $(date)

=== 1. 系统环境 ===
$(uname -a)
$(java -version)

=== 2. 磁盘使用 ===
$(du -sh paimon-warehouse)

=== 3. 表统计信息 ===
$(sqlite3 metastore.db "SELECT table_name, COUNT(*) FROM manifest_entries GROUP BY table_name;")

=== 4. 压缩状态 ===
$(grep "compaction" logs/*.log | tail -20)

=== 5. 内存使用 ===
$(jps -l | grep Paimon)

=== 6. GC 日志 ===
$(tail -50 gc.log)

EOF

echo "诊断报告已生成: diagnostic-report.txt"
```

---

## 第五部分：贡献指南

### 5.1 向项目贡献注释

#### 贡献流程

```
1. Fork 项目到个人账户
2. Clone 本地开发：git clone https://github.com/yourname/paimon.git
3. 创建特性分支：git checkout -b feature/improve-comments
4. 修改代码并添加注释
5. 提交 PR，说明注释改进的内容
6. 社区审查和反馈
7. 合并到主分支
```

#### PR 提交模板

```markdown
## 描述
本 PR 为 [类名] 补充了详细的中文注释。

## 改进点
- 添加了 XXX 方法的详细说明
- 补充了算法原理的具体例子
- 改进了 YYY 的注释格式

## 关键改变
- [x] 添加了 JavaDoc
- [x] 补充了代码内注释
- [x] 验证了示例代码
- [x] 遵循了注释规范

## 相关文件
- `paimon-core/src/main/java/.../ClassName.java`

## 参考资源
- 见 `paimon-other/analysis/注释规范文档.md`
```

### 5.2 建立注释改进任务

#### GitHub Issue 模板

```markdown
## 标题
[注释改进] 为 UniversalCompaction 添加详细的算法说明

## 优先级
- [ ] 高 - 核心关键类
- [ ] 中 - 重要功能类
- [ ] 低 - 辅助工具类

## 当前状态
缺少详细的压缩触发条件说明和具体数值示例

## 建议改进
1. 添加三大触发条件的详细说明
2. 补充具体数值计算示例
3. 参考 RocksDB 的文档说明

## 评估时间
- 预计工作量：2 小时
- 难度等级：中

## 分配给
@contributor-name
```

---

## 第六部分：知识库维护

### 6.1 建立项目 Wiki

#### Wiki 结构建议

```
Home (首页)
├── 快速开始
├── 架构设计
│   ├── 项目结构
│   ├── 分层架构
│   └── 模块依赖
├── 核心算法
│   ├── LSM 树压缩
│   ├── 多维索引
│   └── 数据合并
├── 集成指南
│   ├── Flink 集成
│   ├── Spark 集成
│   └── 自定义集成
├── 性能优化
│   ├── 压缩优化
│   ├── 查询优化
│   └── 内存优化
├── 问题排查
│   ├── 常见问题
│   ├── 性能诊断
│   └── 故障恢复
└── 贡献指南
    ├── 开发流程
    ├── 代码规范
    └── 文档规范
```

### 6.2 建立最佳实践库

#### 实践文档示例

**文件**: `best-practices/performance-tuning.md`

```markdown
# 性能优化最佳实践

## 1. 压缩参数优化

### 对于 1TB 以下的表
- maxSizeAmp: 150
- sizeRatio: 2
- numRunTrigger: 5

### 对于 1-10TB 的表
- maxSizeAmp: 100
- sizeRatio: 5
- numRunTrigger: 10

## 2. 索引创建策略

### 什么时候创建文件索引
- 高频查询的列
- 基数适中的列（1K-1M）
- 不适合全局索引的场景

### 什么时候创建全局索引
- 常用于 Lookup Join
- 热键数据
- 可接受额外的存储开销
```

---

## 第七部分：检查清单

### 快速参考清单

#### 📋 月度维护清单

```
[ ] 检查注释覆盖率（目标 >= 80%）
[ ] 审查过期的注释并更新
[ ] 检查代码示例是否仍可执行
[ ] 验证文档中的参考链接有效性
[ ] 检查是否有新的算法或模块需要文档化
[ ] 运行性能诊断脚本收集数据
[ ] 审查问题追踪系统中的文档相关 Issue
[ ] 更新最佳实践库
```

#### 📋 季度审查清单

```
[ ] 评估注释质量评分趋势
[ ] 更新项目结构和模块分析
[ ] 综合新增功能完善文档
[ ] 组织技术分享会分享学习收获
[ ] 制定下一季度改进计划
[ ] 归纳常见问题和解决方案
```

#### 📋 版本发布清单

```
[ ] 审查该版本的所有代码改动
[ ] 更新与新功能相关的文档
[ ] 生成版本变更日志（Changelog）
[ ] 更新 API 文档（JavaDoc）
[ ] 性能基准测试对比
[ ] 撰写版本博客或技术文章
[ ] 更新快速开始指南
```

---

## 第八部分：工具与自动化

### 8.1 持续集成检查

#### GitHub Actions 配置示例

```yaml
name: Documentation Quality Check

on: [pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Check JavaDoc Coverage
        run: mvn javadoc:javadoc -DfailOnError=true

      - name: Validate Comments
        run: |
          # 检查公开类是否有 JavaDoc
          find . -name "*.java" -exec grep -l "public class" {} \; | \
          while read file; do
            if ! grep -q "/\*\*" "$file"; then
              echo "❌ $file 缺少 JavaDoc"
              exit 1
            fi
          done

      - name: Check Links
        run: |
          # 检查文档中的链接
          find . -name "*.md" -exec \
          grep -oE 'https://[^ ]*' {} \; | \
          sort | uniq | \
          while read url; do
            curl -s -f "$url" || echo "⚠️ 链接失效: $url"
          done
```

### 8.2 自动生成文档

#### JavaDoc 自动生成

```bash
#!/bin/bash
# 生成 HTML 文档

mvn clean javadoc:javadoc \
    -DreportOutputDirectory=./target/apidocs \
    -Dencoding=UTF-8 \
    -Dcharset=UTF-8

echo "JavaDoc 已生成到: target/apidocs"
```

---

## 常见问题（FAQ）

### Q: 多久检查一次注释质量？

**A**: 建议频率：
- **代码审查**: 每次 PR 合并前检查
- **月度统计**: 每月运行一次覆盖率分析
- **季度审查**: 每三个月完整审查一次
- **版本发布**: 发布前完整检查所有文档

### Q: 如何处理过时的注释？

**A**: 三个步骤：
1. 立即识别并标记：添加 `// FIXME: 注释过时，详见 Issue #XYZ`
2. 创建 Issue 追踪：记录过时的原因和需要的改进
3. 及时修复：在相关 PR 中一起修复

### Q: 如何鼓励开发者编写好注释？

**A**:
1. **代码审查**: 将注释作为审查要点
2. **激励机制**: 在发布说明中特别提及优秀注释
3. **文化建设**: 定期分享好的注释示例
4. **培训**: 组织注释规范的讲座和工作坊

---

## 联系方式

- **项目主页**: https://paimon.apache.org/
- **GitHub**: https://github.com/apache/incubator-paimon
- **社区讨论**: dev@paimon.apache.org
- **Bug 报告**: https://github.com/apache/incubator-paimon/issues

---

**文档版本**: v1.0
**最后更新**: 2026年2月12日
**维护者**: Paimon 社区
**许可证**: Apache License 2.0
