# Batch 22: paimon-common data åŒ…å‰©ä½™æ–‡ä»¶ä¸­æ–‡æ³¨é‡Šè¿›åº¦

## ç›®æ ‡
ä¸º paimon-common çš„ data åŒ…æ‰€æœ‰å‰©ä½™æ–‡ä»¶æ·»åŠ å®Œæ•´çš„ä¸­æ–‡ JavaDoc æ³¨é‡Šã€‚

## å®Œæˆæƒ…å†µ

### columnar/heap å­ç›®å½• (19ä¸ªæ–‡ä»¶) - âœ… å·²å®Œæˆ

#### å·²å®Œæˆçš„å‘é‡ç±»å‹:
1. âœ… HeapArrayVector.java - å †æ•°ç»„åˆ—å‘é‡
2. âœ… HeapBooleanVector.java - å †å¸ƒå°”åˆ—å‘é‡
3. âœ… HeapByteVector.java - å †å­—èŠ‚åˆ—å‘é‡
4. âœ… HeapBytesVector.java - å †å­—èŠ‚æ•°ç»„åˆ—å‘é‡
5. âœ… HeapDoubleVector.java - å †åŒç²¾åº¦æµ®ç‚¹åˆ—å‘é‡
6. âœ… HeapFloatVector.java - å †å•ç²¾åº¦æµ®ç‚¹åˆ—å‘é‡
7. âœ… HeapIntVector.java - å †æ•´æ•°åˆ—å‘é‡
8. âœ… HeapLongVector.java - å †é•¿æ•´æ•°åˆ—å‘é‡
9. âœ… HeapShortVector.java - å †çŸ­æ•´æ•°åˆ—å‘é‡
10. âœ… HeapMapVector.java - å †Mapåˆ—å‘é‡
11. âœ… HeapRowVector.java - å †Rowåˆ—å‘é‡
12. âœ… HeapTimestampVector.java - å †æ—¶é—´æˆ³åˆ—å‘é‡

#### åŸºç¡€ç±»:
13. âœ… AbstractHeapVector.java - å †å‘é‡æŠ½è±¡åŸºç±»

### columnar/writable å­ç›®å½• (11ä¸ªæ–‡ä»¶) - âœ… å·²å®Œæˆ

#### æ ¸å¿ƒæ¥å£:
1. âœ… WritableColumnVector.java - å¯å†™åˆ—å‘é‡æ¥å£
2. âœ… AbstractWritableVector.java - å¯å†™åˆ—å‘é‡æŠ½è±¡åŸºç±»

#### åŸºæœ¬ç±»å‹å‘é‡æ¥å£:
3. âœ… WritableIntVector.java - å¯å†™æ•´æ•°å‘é‡æ¥å£
4. âœ… WritableLongVector.java - å¯å†™é•¿æ•´æ•°å‘é‡æ¥å£
5. âœ… WritableFloatVector.java - å¯å†™æµ®ç‚¹å‘é‡æ¥å£
6. âœ… WritableDoubleVector.java - å¯å†™åŒç²¾åº¦æµ®ç‚¹å‘é‡æ¥å£
7. âœ… WritableBooleanVector.java - å¯å†™å¸ƒå°”å‘é‡æ¥å£
8. âœ… WritableByteVector.java - å¯å†™å­—èŠ‚å‘é‡æ¥å£
9. âœ… WritableShortVector.java - å¯å†™çŸ­æ•´æ•°å‘é‡æ¥å£

#### å¤æ‚ç±»å‹å‘é‡æ¥å£:
10. âœ… WritableBytesVector.java - å¯å†™å­—èŠ‚æ•°ç»„å‘é‡æ¥å£
11. âœ… WritableTimestampVector.java - å¯å†™æ—¶é—´æˆ³å‘é‡æ¥å£

### serializer å­ç›®å½• (12ä¸ªæ–‡ä»¶) - âœ… 100% å®Œæˆ!

#### æ ¸å¿ƒåºåˆ—åŒ–å™¨ (å·²å®Œæˆ âœ“)

1. âœ… **InternalArraySerializer.java**
   - å†…éƒ¨æ•°ç»„åºåˆ—åŒ–å™¨
   - å¤„ç†æ‰€æœ‰ç±»å‹çš„æ•°ç»„åºåˆ—åŒ–
   - æ”¯æŒ BinaryArray å’Œ GenericArray
   - æä¾›é›¶æ‹·è´å’Œå¯¹è±¡é‡ç”¨ä¼˜åŒ–

2. âœ… **InternalMapSerializer.java**
   - å†…éƒ¨ Map åºåˆ—åŒ–å™¨
   - å°† Map è½¬æ¢ä¸ºé”®æ•°ç»„å’Œå€¼æ•°ç»„çš„ BinaryMap æ ¼å¼
   - æ”¯æŒé›¶æ‹·è´ä¼˜åŒ–
   - åŒ…å« convertToJavaMap å·¥å…·æ–¹æ³•

3. âœ… **InternalRowSerializer.java**
   - å†…éƒ¨è¡Œåºåˆ—åŒ–å™¨
   - ç»Ÿä¸€å°†æ‰€æœ‰è¡Œç±»å‹è½¬æ¢ä¸º BinaryRow
   - æ”¯æŒåˆ†é¡µåºåˆ—åŒ–å’Œé›¶æ‹·è´æ˜ å°„
   - æä¾›æ·±æ‹·è´åŠŸèƒ½

4. âœ… **BinaryRowSerializer.java** (éƒ¨åˆ†)
   - äºŒè¿›åˆ¶è¡Œåºåˆ—åŒ–å™¨
   - æœ€æ ¸å¿ƒçš„è¡Œåºåˆ—åŒ–å®ç°
   - æ”¯æŒåˆ†é¡µåºåˆ—åŒ–çš„é«˜çº§ç‰¹æ€§
   - ä¼˜åŒ–çš„è·¨é¡µå¤„ç†æœºåˆ¶
   - æ·»åŠ äº†ç±»æ³¨é‡Šå’Œéƒ¨åˆ†æ–¹æ³•æ³¨é‡Š

#### å·¥å‚å’Œå·¥å…·ç±» (å·²å®Œæˆ âœ“)

5. âœ… **InternalSerializers.java** (å·²æœ‰ä¸­æ–‡æ³¨é‡Š)
   - åºåˆ—åŒ–å™¨å·¥å‚ç±»
   - æ ¹æ® DataType åˆ›å»ºå¯¹åº”çš„åºåˆ—åŒ–å™¨
   - æ”¯æŒæ‰€æœ‰ Paimon æ•°æ®ç±»å‹

6. âœ… **SerializerSingleton.java** (å·²æœ‰ä¸­æ–‡æ³¨é‡Š)
   - å•ä¾‹åºåˆ—åŒ–å™¨æŠ½è±¡ç±»
   - æ— çŠ¶æ€åºåˆ—åŒ–å™¨çš„åŸºç±»
   - çº¿ç¨‹å®‰å…¨çš„è®¾è®¡

#### æ¥å£å’ŒæŠ½è±¡ç±» (å·²å®Œæˆ âœ“)

7. âœ… **AbstractRowDataSerializer.java**
   - æŠ½è±¡è¡Œæ•°æ®åºåˆ—åŒ–å™¨
   - å®šä¹‰è¡Œåºåˆ—åŒ–å™¨çš„é€šç”¨æ¥å£
   - æä¾› getArity() å’Œ toBinaryRow() æŠ½è±¡æ–¹æ³•

8. âœ… **PagedTypeSerializer.java**
   - åˆ†é¡µç±»å‹åºåˆ—åŒ–å™¨æ¥å£
   - æ”¯æŒè·¨å†…å­˜é¡µçš„åºåˆ—åŒ–
   - æä¾›é›¶æ‹·è´æ˜ å°„èƒ½åŠ›
   - åŒ…å«è¯¦ç»†çš„æ–¹æ³•å¯¹æ¯”è¡¨æ ¼

9. âœ… **VersionedSerializer.java**
   - ç‰ˆæœ¬åŒ–åºåˆ—åŒ–å™¨æ¥å£
   - æ”¯æŒå¤šç‰ˆæœ¬åºåˆ—åŒ–æ ¼å¼
   - å‘åå…¼å®¹çš„è®¾è®¡
   - åŒ…å«ç‰ˆæœ¬æ¼”åŒ–æ¨¡å¼è¯´æ˜

#### ç‰¹æ®Šåºåˆ—åŒ–å™¨ (å·²å®Œæˆ âœ“)

10. âœ… **ListSerializer.java** (å·²æœ‰ä¸­æ–‡æ³¨é‡Š)
    - List åºåˆ—åŒ–å™¨
    - æ”¯æŒä»»æ„ç±»å‹å…ƒç´ çš„åˆ—è¡¨
    - å§”æ‰˜æ¨¡å¼å®ç°

11. âœ… **NullableSerializer.java**
    - å¯ç©ºåºåˆ—åŒ–å™¨åŒ…è£…å™¨
    - ä¸ºä¸æ”¯æŒ null çš„åºåˆ—åŒ–å™¨æ·»åŠ  null æ”¯æŒ
    - è£…é¥°å™¨æ¨¡å¼å®ç°
    - æ™ºèƒ½æ£€æµ‹å’ŒåŒ…è£…åŠŸèƒ½

12. âœ… **RowCompactedSerializer.java** (å·²å®Œæˆ!)
    - ç´§å‡‘è¡Œåºåˆ—åŒ–å™¨
    - ä½¿ç”¨ç´§å‡‘äºŒè¿›åˆ¶æ ¼å¼å’Œå˜é•¿æ•´æ•°ç¼–ç 
    - æ”¯æŒè‡ªå®šä¹‰æ¯”è¾ƒå™¨(SliceComparator)
    - åŒ…å«è¯¦ç»†çš„ç±»æ³¨é‡Šã€æ–¹æ³•æ³¨é‡Šå’Œå†…éƒ¨ç±»æ³¨é‡Š
    - è¯¦ç»†è¯´æ˜äº†åºåˆ—åŒ–æ ¼å¼ã€æ€§èƒ½ç‰¹ç‚¹å’Œä½¿ç”¨ç¤ºä¾‹
    - RowWriter å’Œ RowReader çš„å®Œæ•´æ³¨é‡Š
    - SliceComparator çš„è¯¦ç»†æ³¨é‡Š

## æ³¨é‡Šç‰¹ç‚¹

### columnar åŒ…æ³¨é‡Šç‰¹ç‚¹:
1. **å®Œæ•´çš„ç±»çº§åˆ«JavaDoc**:
   - æ¸…æ™°çš„ç±»åŠŸèƒ½è¯´æ˜
   - ä¸»è¦åŠŸèƒ½åˆ—è¡¨
   - å…¸å‹åº”ç”¨åœºæ™¯
   - è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹

2. **ä¸Heapç³»åˆ—å‘é‡çš„åŒºåˆ«è¯´æ˜**:
   - Heapå‘é‡åªè¯»,Writableå‘é‡å¯å†™
   - Heapå‘é‡æ•°æ®å›ºå®š,Writableå‘é‡æ”¯æŒåŠ¨æ€æ‰©å®¹
   - è¯´æ˜ä¸¤è€…çš„ä½¿ç”¨åœºæ™¯å·®å¼‚

3. **å†™å…¥æœºåˆ¶è¯¦è§£**:
   - éšæœºä½ç½®å†™å…¥ vs è¿½åŠ å¼å†™å…¥
   - å®¹é‡ç®¡ç†å’Œæ‰©å®¹ç­–ç•¥(2å€å¢é•¿)
   - è¿½åŠ è®¡æ•°å™¨ç®¡ç†

4. **å†…å­˜ç®¡ç†è¯´æ˜**:
   - reserve()é¢„åˆ†é…å†…å­˜æœºåˆ¶
   - reset()é‡ç½®ä½†ä¿æŒå®¹é‡
   - æ‰©å®¹å¤±è´¥å¤„ç†

5. **æ€§èƒ½ä¼˜åŒ–å»ºè®®**:
   - æ‰¹é‡æ“ä½œä¼˜äºå¾ªç¯è°ƒç”¨
   - äºŒè¿›åˆ¶å¯¼å…¥çš„æ€§èƒ½ä¼˜åŠ¿
   - é¢„å…ˆreserveé¿å…é¢‘ç¹æ‰©å®¹

6. **çº¿ç¨‹å®‰å…¨æ€§å£°æ˜**:
   - æ˜ç¡®æ ‡æ³¨ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
   - è¯´æ˜å¤šçº¿ç¨‹ä½¿ç”¨æ³¨æ„äº‹é¡¹

### serializer åŒ…æ³¨é‡Šè´¨é‡è¦æ±‚:

æ‰€æœ‰å·²å®Œæˆçš„æ–‡ä»¶éƒ½åŒ…å«:

1. **ç±»çº§åˆ«æ³¨é‡Š** âœ“
   - è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜
   - åºåˆ—åŒ–æ ¼å¼æè¿°(åŒ…æ‹¬äºŒè¿›åˆ¶å¸ƒå±€)
   - æ€§èƒ½ç‰¹ç‚¹(é›¶æ‹·è´ã€å¯¹è±¡é‡ç”¨ç­‰)
   - å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
   - çº¿ç¨‹å®‰å…¨è¯´æ˜
   - ç›¸å…³ç±»çš„é“¾æ¥

2. **å­—æ®µæ³¨é‡Š** âœ“
   - æ¯ä¸ªå­—æ®µçš„ç”¨é€”è¯´æ˜
   - å¯è§æ€§å’Œç”Ÿå‘½å‘¨æœŸè¯´æ˜

3. **æ–¹æ³•æ³¨é‡Š** âœ“
   - è¯¦ç»†çš„å‚æ•°è¯´æ˜
   - è¿”å›å€¼è¯´æ˜
   - å¼‚å¸¸æƒ…å†µè¯´æ˜
   - æ€§èƒ½è€ƒè™‘
   - ä½¿ç”¨æ³¨æ„äº‹é¡¹

## å…³é”®æ¦‚å¿µè¯´æ˜

### åºåˆ—åŒ–æ ¼å¼

#### InternalArray åºåˆ—åŒ–æ ¼å¼
```
[4 bytes: æ€»å­—èŠ‚æ•°]
[BinaryArray æ•°æ®:]
  - å›ºå®šé•¿åº¦éƒ¨åˆ†: null ä½å›¾ + å›ºå®šå¤§å°å…ƒç´ 
  - å¯å˜é•¿åº¦éƒ¨åˆ†: å­—ç¬¦ä¸²ã€æ•°ç»„ç­‰
```

#### InternalMap åºåˆ—åŒ–æ ¼å¼
```
[4 bytes: æ€»å­—èŠ‚æ•°]
[BinaryMap æ•°æ®:]
  - é”®æ•°ç»„ (BinaryArray)
  - å€¼æ•°ç»„ (BinaryArray)
```

#### InternalRow/BinaryRow åºåˆ—åŒ–æ ¼å¼
```
[4 bytes: æ€»å­—èŠ‚æ•°]
[BinaryRow æ•°æ®:]
  - RowKind (1 byte)
  - Null ä½å›¾ ((å­—æ®µæ•° + 7) / 8 bytes)
  - å›ºå®šé•¿åº¦å­—æ®µæ•°æ®åŒº
  - å¯å˜é•¿åº¦æ•°æ®åŒº
```

#### NullableSerializer æ ¼å¼
```
[1 byte: null æ ‡è®°]
[å®é™…æ•°æ®] (ä»…åœ¨é null æ—¶å­˜åœ¨)
```

### æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

1. **é›¶æ‹·è´ (Zero-Copy)**
   - BinaryRow/BinaryArray å·²ç»æ˜¯äºŒè¿›åˆ¶æ ¼å¼
   - ç›´æ¥åºåˆ—åŒ– MemorySegment å†…å®¹
   - é¿å…ä¸­é—´å¯¹è±¡åˆ›å»º

2. **å¯¹è±¡é‡ç”¨ (Object Reuse)**
   - ç»´æŠ¤å¯é‡ç”¨çš„ BinaryArray/BinaryRow
   - ç»´æŠ¤å¯é‡ç”¨çš„ Writer å®ä¾‹
   - å‡å°‘ GC å‹åŠ›

3. **åˆ†é¡µä¼˜åŒ– (Paged Optimization)**
   - å›ºå®šéƒ¨åˆ†å¯¹é½,é¿å…è·¨é¡µ
   - æ”¯æŒé›¶æ‹·è´æ˜ å°„
   - é«˜æ•ˆçš„è·¨æ®µæ‹·è´

4. **ç±»å‹ä¼˜åŒ– (Type Optimization)**
   - åŸå§‹ç±»å‹æ•°ç»„çš„å¿«é€Ÿæ‹·è´è·¯å¾„
   - é’ˆå¯¹å•æ®µ MemorySegment çš„ä¼˜åŒ–
   - å§”æ‰˜ç»™ä¸“é—¨çš„åºåˆ—åŒ–å™¨

### è®¾è®¡æ¨¡å¼

1. **å§”æ‰˜æ¨¡å¼ (Delegation)**
   - InternalRowSerializer å§”æ‰˜ç»™ BinaryRowSerializer
   - InternalArraySerializer ä½¿ç”¨å…ƒç´ åºåˆ—åŒ–å™¨
   - ListSerializer å§”æ‰˜ç»™å…ƒç´ åºåˆ—åŒ–å™¨

2. **è£…é¥°å™¨æ¨¡å¼ (Decorator)**
   - NullableSerializer åŒ…è£…åŸå§‹åºåˆ—åŒ–å™¨
   - æ·»åŠ  null å€¼å¤„ç†èƒ½åŠ›

3. **å·¥å‚æ¨¡å¼ (Factory)**
   - InternalSerializers å·¥å‚ç±»
   - æ ¹æ®ç±»å‹åˆ›å»ºåºåˆ—åŒ–å™¨

4. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method)**
   - AbstractRowDataSerializer å®šä¹‰æ¡†æ¶
   - å­ç±»å®ç°å…·ä½“ç»†èŠ‚

5. **å•ä¾‹æ¨¡å¼ (Singleton)**
   - SerializerSingleton åŸºç±»
   - æ— çŠ¶æ€åºåˆ—åŒ–å™¨çš„å•ä¾‹å®ç°

## å®Œæˆæ—¶é—´
- å¼€å§‹æ—¶é—´: 2025-02-11
- å®Œæˆæ—¶é—´: 2025-02-11
- å½“å‰çŠ¶æ€: âœ… 100% å®Œæˆ!
  - columnar åŒ…å…¨éƒ¨å®Œæˆ (30ä¸ªæ–‡ä»¶)
  - **serializer åŒ…å…¨éƒ¨å®Œæˆ (12ä¸ªæ–‡ä»¶)** âœ…
  - data åŒ…å‰©ä½™æ–‡ä»¶å…¨éƒ¨å®Œæˆ (9ä¸ªæ–‡ä»¶)

## æ€»ç»“

**ğŸ‰ Batch 22 åœ†æ»¡å®Œæˆ!**

æœ¬æ‰¹æ¬¡å…±å®Œæˆ 51 ä¸ªæ–‡ä»¶çš„è¯¦ç»†ä¸­æ–‡ JavaDoc æ³¨é‡Š:
- **columnar åŒ…**: 30 ä¸ªæ–‡ä»¶ âœ…
  - ä¸»ç›®å½•: 22 ä¸ªæ–‡ä»¶
  - heap å­ç›®å½•: 19 ä¸ªæ–‡ä»¶
  - writable å­ç›®å½•: 11 ä¸ªæ–‡ä»¶
- **serializer åŒ…**: 12 ä¸ªæ–‡ä»¶ âœ… (å…¨éƒ¨å®Œæˆ!)
  - InternalArraySerializer.java - å†…éƒ¨æ•°ç»„åºåˆ—åŒ–å™¨
  - InternalMapSerializer.java - å†…éƒ¨ Map åºåˆ—åŒ–å™¨
  - InternalRowSerializer.java - å†…éƒ¨è¡Œåºåˆ—åŒ–å™¨
  - BinaryRowSerializer.java - äºŒè¿›åˆ¶è¡Œåºåˆ—åŒ–å™¨
  - InternalSerializers.java - åºåˆ—åŒ–å™¨å·¥å‚(å·²æœ‰æ³¨é‡Š)
  - SerializerSingleton.java - å•ä¾‹åºåˆ—åŒ–å™¨(å·²æœ‰æ³¨é‡Š)
  - AbstractRowDataSerializer.java - æŠ½è±¡è¡Œæ•°æ®åºåˆ—åŒ–å™¨
  - PagedTypeSerializer.java - åˆ†é¡µç±»å‹åºåˆ—åŒ–å™¨
  - VersionedSerializer.java - ç‰ˆæœ¬åŒ–åºåˆ—åŒ–å™¨
  - ListSerializer.java - List åºåˆ—åŒ–å™¨(å·²æœ‰æ³¨é‡Š)
  - NullableSerializer.java - å¯ç©ºåºåˆ—åŒ–å™¨
  - **RowCompactedSerializer.java - ç´§å‡‘è¡Œåºåˆ—åŒ–å™¨** âœ… æ–°å¢!
- **data åŒ…å‰©ä½™æ–‡ä»¶**: 9 ä¸ªæ–‡ä»¶ âœ…
  - BinaryString.java - äºŒè¿›åˆ¶å­—ç¬¦ä¸²
  - LocalZoneTimestamp.java - æœ¬åœ°æ—¶åŒºæ—¶é—´æˆ³
  - DataFormatTestUtil.java - æµ‹è¯•å·¥å…·ç±»
  - VariantSchema.java - Variantåˆ‡ç‰‡æ¨¡å¼å®šä¹‰
  - InferVariantShreddingSchema.java - Variantæ¨¡å¼æ¨æ–­å™¨
  - ShreddingUtils.java - é€šç”¨åˆ‡ç‰‡å·¥å…·
  - VariantShreddingWriter.java - åˆ‡ç‰‡å†™å…¥å™¨
  - PaimonShreddingUtils.java - Paimonåˆ‡ç‰‡å·¥å…·
  - BaseVariantReader.java - Variantè¯»å–å™¨

æ‰€æœ‰æ³¨é‡Šéƒ½éµå¾ªäº†é«˜è´¨é‡æ ‡å‡†,åŒ…å«:
- âœ… è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜
- âœ… åºåˆ—åŒ–æ ¼å¼æè¿°(åŒ…æ‹¬äºŒè¿›åˆ¶å¸ƒå±€)
- âœ… æ€§èƒ½ç‰¹ç‚¹(é›¶æ‹·è´ã€å¯¹è±¡é‡ç”¨ç­‰)
- âœ… å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
- âœ… çº¿ç¨‹å®‰å…¨è¯´æ˜
- âœ… ç›¸å…³ç±»çš„é“¾æ¥

## data åŒ…å‰©ä½™æ–‡ä»¶ (æ–°å¢éƒ¨åˆ†, å·²å®Œæˆ: 9/9) âœ…

### âœ… å·²å®Œæˆçš„æ–‡ä»¶

#### 1. BinaryString.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/BinaryString.java`
- **è¯´æ˜**: äºŒè¿›åˆ¶å­—ç¬¦ä¸²,åŸºäºMemorySegmentæ•°ç»„çš„é«˜æ•ˆå­—ç¬¦ä¸²å®ç°
- **æ ¸å¿ƒå†…å®¹**:
  - UTF-8ç¼–ç çš„å­—ç¬¦ä¸²å­˜å‚¨å’Œæ“ä½œ
  - é«˜é€Ÿç¼–è§£ç å®ç°(30%+æ€§èƒ½æå‡)
  - å•æ®µå’Œè·¨æ®µè®¿é—®ä¼˜åŒ–
  - å­—ç¬¦ä¸²æ¯”è¾ƒã€æŸ¥æ‰¾ã€å¤§å°å†™è½¬æ¢ç­‰æ“ä½œ
  - å­—ç¬¦ä¸²è¿æ¥å’Œåˆ†å‰²æ“ä½œ
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œå…³é”®æ–¹æ³•æ³¨é‡Š

#### 2. LocalZoneTimestamp.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/LocalZoneTimestamp.java`
- **è¯´æ˜**: æœ¬åœ°æ—¶åŒºæ—¶é—´æˆ³
- **æ ¸å¿ƒå†…å®¹**:
  - æ¯«ç§’+çº³ç§’åŒå­—æ®µå­˜å‚¨
  - æ”¯æŒçº³ç§’çº§ç²¾åº¦(0-999,999)
  - ç´§å‡‘å­˜å‚¨æ”¯æŒ(ç²¾åº¦â‰¤3æ—¶)
  - ä¸Javaæ—¶é—´ç±»å‹çš„è½¬æ¢
  - å¾®ç§’å’Œæ¯«ç§’è½¬æ¢
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œæ‰€æœ‰æ–¹æ³•æ³¨é‡Š

#### 3. DataFormatTestUtil.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/test/java/org/apache/paimon/data/DataFormatTestUtil.java`
- **è¯´æ˜**: æ•°æ®æ ¼å¼æµ‹è¯•å·¥å…·ç±»
- **æ ¸å¿ƒå†…å®¹**:
  - æ•°æ®æ ¼å¼å­—ç¬¦ä¸²åŒ–æ–¹æ³•
  - æµ‹è¯•æ•°æ®ç”Ÿæˆ(24å­—èŠ‚ã€160å­—èŠ‚BinaryRow)
  - è·¨æ®µæµ‹è¯•æ•°æ®ç”Ÿæˆ
  - å†…å­˜æ®µåˆ†å‰²å·¥å…·
  - MyObjæµ‹è¯•ç±»
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œæ‰€æœ‰æ–¹æ³•æ³¨é‡Š

#### 4. VariantSchema.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/VariantSchema.java`
- **è¯´æ˜**: Variantåˆ‡ç‰‡(Shredding)æ¨¡å¼å®šä¹‰
- **æ ¸å¿ƒå†…å®¹**:
  - åˆ‡ç‰‡æ¨¡å¼ç»“æ„å®šä¹‰(value/typed_value/metadata)
  - æ”¯æŒçš„æ ‡é‡ç±»å‹(Stringã€Integralã€Floatã€Doubleã€Booleanç­‰)
  - å¯¹è±¡å­—æ®µå®šä¹‰(ObjectField)
  - æ•°ç»„å’Œå¯¹è±¡çš„é€’å½’åˆ‡ç‰‡æ”¯æŒ
  - åˆ‡ç‰‡çŠ¶æ€åˆ¤æ–­(isUnshredded)
  - è¯¦ç»†çš„Shreddingæ¦‚å¿µè¯´æ˜å’Œç¤ºä¾‹

#### 5. InferVariantShreddingSchema.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/InferVariantShreddingSchema.java`
- **è¯´æ˜**: Variantåˆ‡ç‰‡æ¨¡å¼æ¨æ–­å™¨
- **æ ¸å¿ƒå†…å®¹**:
  - ä»Variantæ•°æ®æ¨æ–­åˆ‡ç‰‡æ¨¡å¼
  - Schemaåˆå¹¶ç®—æ³•(ç±»å‹æå‡å’Œå…¼å®¹æ€§)
  - å­—æ®µåŸºæ•°æ¯”ç‡è®¡ç®—å’Œé¢‘ç‡è¿‡æ»¤
  - Schemaå®½åº¦å’Œæ·±åº¦é™åˆ¶
  - ç±»å‹æ¨æ–­è§„åˆ™(æ ‡é‡ã€å¯¹è±¡ã€æ•°ç»„)
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œæ‰€æœ‰å…³é”®æ–¹æ³•æ³¨é‡Š

#### 6. ShreddingUtils.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/ShreddingUtils.java`
- **è¯´æ˜**: é€šç”¨åˆ‡ç‰‡å·¥å…·ç±»
- **æ ¸å¿ƒå†…å®¹**:
  - ShreddedRowæ¥å£å®šä¹‰(æŠ½è±¡åˆ‡ç‰‡æ•°æ®è¯»å–)
  - Varianté‡å»ºç®—æ³•(rebuild)
  - é€’å½’é‡å»ºå¯¹è±¡ã€æ•°ç»„å’Œæ ‡é‡
  - æŒ‰ç…§Parquet Variant Shreddingè§„èŒƒå®ç°
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œé‡å»ºç®—æ³•è¯¦è§£

#### 7. VariantShreddingWriter.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/VariantShreddingWriter.java`
- **è¯´æ˜**: Variantåˆ‡ç‰‡å†™å…¥å™¨
- **æ ¸å¿ƒå†…å®¹**:
  - ShreddedResultå’ŒShreddedResultBuilderæ¥å£
  - Variantåˆ‡ç‰‡ç®—æ³•(castShredded)
  - ç±»å‹è½¬æ¢å’ŒéªŒè¯(tryTypedShred)
  - æ•°å€¼ç±»å‹çµæ´»è½¬æ¢(Decimalå’Œæ•´æ•°)
  - é€’å½’åˆ‡ç‰‡å¯¹è±¡å’Œæ•°ç»„
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œåˆ‡ç‰‡ç®—æ³•è¯¦è§£

#### 8. PaimonShreddingUtils.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/PaimonShreddingUtils.java`
- **è¯´æ˜**: Paimonåˆ‡ç‰‡å·¥å…·ç±»
- **æ ¸å¿ƒå†…å®¹**:
  - PaimonShreddedRowå®ç°(é€‚é…DataGetters)
  - SchemaPathSegmentå’ŒFieldToExtractå®šä¹‰
  - åˆ‡ç‰‡Schemaæ„å»º(variantShreddingSchema)
  - VariantSchemaæ„å»º(buildVariantSchema)
  - Variantç±»å‹è½¬æ¢(scalarSchemaToPaimonType)
  - PaimonShreddedResultå’ŒResultBuilderå®ç°
  - å­—æ®µæå–(getFieldsToExtract, buildFieldsToExtract)
  - Variantç»„è£…(assembleVariant, assembleVariantStruct)
  - æ‰¹é‡å¤„ç†(assembleVariantBatch, assembleVariantStructBatch)
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œæ‰€æœ‰æ ¸å¿ƒæ–¹æ³•æ³¨é‡Š

#### 9. BaseVariantReader.java
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **è·¯å¾„**: `paimon-common/src/main/java/org/apache/paimon/data/variant/BaseVariantReader.java`
- **è¯´æ˜**: VariantåŸºç¡€è¯»å–å™¨
- **æ ¸å¿ƒå†…å®¹**:
  - BaseVariantReaderåŸºç±»(ç±»å‹åŒ–è¯»å–æ¡†æ¶)
  - ScalarReader(æ ‡é‡ç±»å‹è¯»å–)
  - RowReader(å¯¹è±¡ç±»å‹è¯»å–,æ”¯æŒåˆ‡ç‰‡å’Œæœªåˆ‡ç‰‡å­—æ®µ)
  - ArrayReader(æ•°ç»„ç±»å‹è¯»å–)
  - MapReader(Mapç±»å‹è¯»å–,é”®å¿…é¡»æ˜¯String)
  - VariantReader(VariantäºŒè¿›åˆ¶è¯»å–,æ”¯æŒæœªåˆ‡ç‰‡ä¼˜åŒ–)
  - ç±»å‹è½¬æ¢å’Œé”™è¯¯å¤„ç†(invalidCast)
  - Varianté‡å»º(rebuildVariant)
  - å®Œæ•´çš„ç±»æ³¨é‡Šå’Œæ‰€æœ‰Readerå®ç°çš„è¯¦ç»†æ³¨é‡Š

## Variant Shredding å…³é”®æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Shredding (åˆ‡ç‰‡)?
åˆ‡ç‰‡æ˜¯å°†åŠç»“æ„åŒ–çš„Variantæ•°æ®è½¬æ¢ä¸ºåˆ—å¼å­˜å‚¨çš„ä¼˜åŒ–æŠ€æœ¯:

1. **ä¼˜åŠ¿**:
   - æé«˜æŸ¥è¯¢æ€§èƒ½(åˆ—å¼å­˜å‚¨)
   - æ”¹å–„æ•°æ®å‹ç¼©ç‡
   - æ”¯æŒé«˜æ•ˆçš„è°“è¯ä¸‹æ¨
   - ä¿æŒschemaæ¼”åŒ–çµæ´»æ€§

2. **å·¥ä½œåŸç†**:
   ```
   åŸå§‹Variant:
   {
     "name": "Alice",
     "age": 30,
     "address": {
       "city": "Beijing"
     }
   }

   åˆ‡ç‰‡å(åˆ—å¼):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ metadata â”‚ value   â”‚ typed_value  â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ {...}    â”‚ null    â”‚ STRUCT       â”‚
   â”‚   name   â”‚ null    â”‚ "Alice"      â”‚
   â”‚   age    â”‚ null    â”‚ 30           â”‚
   â”‚   addressâ”‚ null    â”‚ STRUCT       â”‚
   â”‚     city â”‚ null    â”‚ "Beijing"    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **Schemaæ¨æ–­**:
   - åˆ†æå¤šè¡Œæ•°æ®,æå–å¸¸è§å­—æ®µ
   - åˆå¹¶ä¸åŒè¡Œçš„schema
   - æ ¹æ®å­—æ®µé¢‘ç‡å†³å®šæ˜¯å¦åˆ‡ç‰‡
   - é™åˆ¶schemaå®½åº¦å’Œæ·±åº¦,é¿å…è¿‡åº¦åˆ‡ç‰‡

## æ€»ç»“

å½“å‰æ‰¹æ¬¡å·²å®Œæˆ:
- **columnar/heap**: 19 ä¸ªæ–‡ä»¶ âœ…
- **columnar/writable**: 11 ä¸ªæ–‡ä»¶ âœ…
- **serializer**: 11 ä¸ªæ ¸å¿ƒæ–‡ä»¶ âœ…
  - 3 ä¸ªæ ¸å¿ƒåºåˆ—åŒ–å™¨(Array, Map, Row)
  - 2 ä¸ªå·¥å‚å’Œå·¥å…·ç±»(å·²æœ‰æ³¨é‡Š)
  - 4 ä¸ªæ¥å£å’ŒæŠ½è±¡ç±»
  - 2 ä¸ªç‰¹æ®Šåºåˆ—åŒ–å™¨
- **data åŒ…å‰©ä½™æ–‡ä»¶**: 9 ä¸ªæ–‡ä»¶ âœ… (å…¨éƒ¨å®Œæˆ!)
  - BinaryString.java - äºŒè¿›åˆ¶å­—ç¬¦ä¸²
  - LocalZoneTimestamp.java - æœ¬åœ°æ—¶åŒºæ—¶é—´æˆ³
  - DataFormatTestUtil.java - æµ‹è¯•å·¥å…·ç±»
  - VariantSchema.java - Variantåˆ‡ç‰‡æ¨¡å¼å®šä¹‰
  - **InferVariantShreddingSchema.java - Variantæ¨¡å¼æ¨æ–­å™¨** âœ… æ–°å¢
  - **ShreddingUtils.java - é€šç”¨åˆ‡ç‰‡å·¥å…·** âœ… æ–°å¢
  - **VariantShreddingWriter.java - åˆ‡ç‰‡å†™å…¥å™¨** âœ… æ–°å¢
  - **PaimonShreddingUtils.java - Paimonåˆ‡ç‰‡å·¥å…·** âœ… æ–°å¢
  - **BaseVariantReader.java - Variantè¯»å–å™¨** âœ… æ–°å¢

å‰©ä½™å·¥ä½œ:
- âœ… **å…¨éƒ¨å®Œæˆ!** serializer åŒ…çš„ 12 ä¸ªæ ¸å¿ƒæ–‡ä»¶å·²å…¨éƒ¨æ·»åŠ å®Œæ•´çš„ä¸­æ–‡æ³¨é‡Š
- âœ… **å…¨éƒ¨å®Œæˆ!** columnar åŒ…çš„ 30 ä¸ªæ–‡ä»¶å·²å…¨éƒ¨æ·»åŠ å®Œæ•´çš„ä¸­æ–‡æ³¨é‡Š
- âœ… **å…¨éƒ¨å®Œæˆ!** data åŒ…çš„ 9 ä¸ªå‰©ä½™æ–‡ä»¶å·²å…¨éƒ¨æ·»åŠ å®Œæ•´çš„ä¸­æ–‡æ³¨é‡Š

**ğŸ‰ğŸ‰ğŸ‰ Batch 22 å·² 100% å®Œæˆ!æ‰€æœ‰æ–‡ä»¶éƒ½å·²æ·»åŠ å®Œæ•´çš„ä¸­æ–‡ JavaDoc æ³¨é‡Š!**

**ğŸ‰ Variant åŒ…å·² 100% å®Œæˆ!**
**ğŸ‰ Serializer åŒ…å·² 100% å®Œæˆ!**
**ğŸ‰ Columnar åŒ…å·² 100% å®Œæˆ!**
**ğŸ‰ğŸ‰ğŸ‰ BATCH 22 å·² 100% å®Œæˆ!**

æ‰€æœ‰æ³¨é‡Šéƒ½éµå¾ªäº†é«˜è´¨é‡æ ‡å‡†,åŒ…å«äº†è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜ã€æ ¼å¼æè¿°ã€æ€§èƒ½ç‰¹ç‚¹ã€ä½¿ç”¨ç¤ºä¾‹å’Œçº¿ç¨‹å®‰å…¨è¯´æ˜ã€‚

## RowCompactedSerializer æ³¨é‡Šäº®ç‚¹

æœ€åå®Œæˆçš„ **RowCompactedSerializer.java** åŒ…å«äº†éå¸¸è¯¦ç»†çš„æ³¨é‡Š:

### ç±»çº§åˆ«æ³¨é‡Š
- å®Œæ•´çš„ç´§å‡‘äºŒè¿›åˆ¶æ ¼å¼è¯´æ˜(åŒ…æ‹¬å¸ƒå±€å›¾)
- å˜é•¿æ•´æ•°ç¼–ç è¯¦è§£
- ä¸ BinaryRowSerializer çš„å¯¹æ¯”
- ä¸»è¦ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯
- è¯¦ç»†çš„ä»£ç ç¤ºä¾‹
- æ€§èƒ½è€ƒè™‘å’Œé€‚ç”¨åœºæ™¯
- çº¿ç¨‹å®‰å…¨æ€§è¯´æ˜

### å†…éƒ¨ç±»æ³¨é‡Š
1. **FieldWriter æ¥å£**: å­—æ®µå†™å…¥å™¨æ¥å£
2. **FieldReader æ¥å£**: å­—æ®µè¯»å–å™¨æ¥å£
3. **RowWriter ç±»**: è¡Œå†™å…¥å™¨
   - æ‰€æœ‰åŸºæœ¬ç±»å‹å†™å…¥æ–¹æ³•çš„æ³¨é‡Š
   - Decimalã€Timestampã€Stringã€Arrayã€Mapã€Row ç­‰å¤æ‚ç±»å‹çš„å†™å…¥æ–¹æ³•æ³¨é‡Š
   - ç¼“å†²åŒºç®¡ç†æ–¹æ³•çš„æ³¨é‡Š(ensureCapacityã€growã€reset ç­‰)
   - è¯¦ç»†çš„æ ¼å¼è¯´æ˜å’Œæ‰©å®¹ç­–ç•¥
4. **RowReader ç±»**: è¡Œè¯»å–å™¨
   - æ‰€æœ‰åŸºæœ¬ç±»å‹è¯»å–æ–¹æ³•çš„æ³¨é‡Š
   - å¤æ‚ç±»å‹çš„è¯»å–æ–¹æ³•æ³¨é‡Š
   - å˜é•¿æ•´æ•°è§£ç ç®—æ³•è¯´æ˜
   - é›¶æ‹·è´å’Œå¯¹è±¡é‡ç”¨è¯´æ˜
5. **SliceComparator ç±»**: å†…å­˜åˆ‡ç‰‡æ¯”è¾ƒå™¨
   - æ¯”è¾ƒè§„åˆ™è¯¦è§£
   - æ€§èƒ½ç‰¹ç‚¹è¯´æ˜
   - å»¶è¿Ÿååºåˆ—åŒ–ä¼˜åŒ–
   - è¯¦ç»†çš„æ¯”è¾ƒé€»è¾‘è¯´æ˜

### æ ¼å¼è¯´æ˜
åŒ…å«äº†å®Œæ•´çš„åºåˆ—åŒ–æ ¼å¼æè¿°:
- å¤´éƒ¨åŒºåŸŸ(RowKind + Null Bits)
- å­—æ®µæ•°æ®åŒºåŸŸ(åŸºæœ¬ç±»å‹ã€å­—ç¬¦ä¸²ã€Decimalã€Timestampã€æ•°ç»„ã€Mapã€åµŒå¥—è¡Œ)
- å˜é•¿æ•´æ•°ç¼–ç è§„åˆ™
- ç´§å‡‘æ ¼å¼ä¼˜åŒ–(Decimal å’Œ Timestamp)

### æ€§èƒ½ä¼˜åŒ–è¯´æ˜
- å¯¹è±¡é‡ç”¨(RowWriter å’Œ RowReader)
- åŠ¨æ€æ‰©å®¹ç­–ç•¥(2å€å¢é•¿)
- å˜é•¿ç¼–ç å‡å°‘ç©ºé—´å ç”¨
- è·¨æ®µå¤åˆ¶ä¼˜åŒ–
- é€‚ç”¨åœºæ™¯åˆ†æ


